'use client';

import React, { useState, useEffect } from 'react';
import { FloatingWindow } from '@/components/ui/floating-window';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue, EnhancedSelect } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Label } from '@/components/ui/label';
import { Separator } from '@/components/ui/separator';
import { SeverityBadge } from './severity-badge';
import { StatusBadge } from './status-badge';

interface Vulnerability {
    id: string;
    title: string;
    severity: string;
    status: string;
    category: string;
    project: string;
    created_at: string;
    description?: string;
    cvss_score?: number;
    cve_id?: string;
    affected_asset?: string;
    recommendation?: string;
    references?: string[];
    updated_at?: string;
}

interface VulnerabilityEditWindowProps {
    isOpen: boolean;
    onClose: () => void;
    vulnerability: Vulnerability | null;
    onSave: (updatedVulnerability: Partial<Vulnerability>) => void;
}

export function VulnerabilityEditWindow({
    isOpen,
    onClose,
    vulnerability,
    onSave,
}: VulnerabilityEditWindowProps) {
    const [formData, setFormData] = useState<Partial<Vulnerability>>({});
    const [isSaving, setIsSaving] = useState(false);

    useEffect(() => {
        if (vulnerability) {
            setFormData(vulnerability);
        }
    }, [vulnerability]);

    const handleInputChange = (field: keyof Vulnerability, value: string | number) => {
        setFormData(prev => ({
            ...prev,
            [field]: value,
        }));
    };

    const handleSave = async () => {
        setIsSaving(true);
        try {
            await onSave(formData);
            onClose();
        } catch (error) {
            console.error('Failed to save vulnerability:', error);
        } finally {
            setIsSaving(false);
        }
    };

    if (!vulnerability) return null;

    return (
        <FloatingWindow
            isOpen={isOpen}
            onClose={onClose}
            title="Edit Vulnerability"
            initialWidth={900}
            initialHeight={650}
        >
            <div className="flex h-full">
                {/* Left Side - Vulnerability Data */}
                <div className="w-1/2 border-r border-gray-200 p-6 space-y-4">
                    <div>
                        <h4 className="text-lg font-semibold text-gray-900 mb-2">Vulnerability Details</h4>
                        <div className="space-y-3">
                            <div>
                                <Label className="text-sm font-medium text-gray-700">Title</Label>
                                <p className="mt-1 text-sm text-gray-900">{vulnerability.title}</p>
                            </div>
                            
                            <div>
                                <Label className="text-sm font-medium text-gray-700">Description</Label>
                                <p className="mt-1 text-sm text-gray-900 whitespace-pre-wrap">{vulnerability.description}</p>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <Label className="text-sm font-medium text-gray-700">Severity</Label>
                                    <div className="mt-1">
                                        <SeverityBadge severity={vulnerability.severity} />
                                    </div>
                                </div>
                                <div>
                                    <Label className="text-sm font-medium text-gray-700">Status</Label>
                                    <div className="mt-1">
                                        <StatusBadge status={vulnerability.status} />
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <Label className="text-sm font-medium text-gray-700">Category</Label>
                                    <p className="mt-1 text-sm text-gray-900">{vulnerability.category}</p>
                                </div>
                                <div>
                                    <Label className="text-sm font-medium text-gray-700">CVSS Score</Label>
                                    <p className="mt-1 text-sm text-gray-900">{vulnerability.cvss_score || 'N/A'}</p>
                                </div>
                            </div>

                            {vulnerability.cve_id && (
                                <div>
                                    <Label className="text-sm font-medium text-gray-700">CVE ID</Label>
                                    <p className="mt-1 text-sm text-gray-900">{vulnerability.cve_id}</p>
                                </div>
                            )}

                            {vulnerability.affected_asset && (
                                <div>
                                    <Label className="text-sm font-medium text-gray-700">Affected Asset</Label>
                                    <p className="mt-1 text-sm text-gray-900">{vulnerability.affected_asset}</p>
                                </div>
                            )}

                            <Separator />

                            <div>
                                <Label className="text-sm font-medium text-gray-700">Recommendation</Label>
                                <p className="mt-1 text-sm text-gray-900 whitespace-pre-wrap">
                                    {vulnerability.recommendation || 'No recommendation provided'}
                                </p>
                            </div>

                            {vulnerability.references && vulnerability.references.length > 0 && (
                                <div>
                                    <Label className="text-sm font-medium text-gray-700">References</Label>
                                    <ul className="mt-1 space-y-1">
                                        {vulnerability.references.map((ref, index) => (
                                            <li key={index} className="text-sm text-blue-600 hover:text-blue-800">
                                                <a href={ref} target="_blank" rel="noopener noreferrer">
                                                    {ref}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )}

                            <Separator />

                            <div className="grid grid-cols-2 gap-4 text-xs text-gray-500">
                                <div>
                                    <Label className="text-xs font-medium">Created</Label>
                                    <p>{new Date(vulnerability.created_at).toLocaleDateString()}</p>
                                </div>
                                <div>
                                    <Label className="text-xs font-medium">Updated</Label>
                                    <p>{vulnerability.updated_at ? new Date(vulnerability.updated_at).toLocaleDateString() : 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Right Side - Edit Form */}
                <div className="w-1/2 p-6 space-y-4">
                    <div>
                        <h4 className="text-lg font-semibold text-gray-900 mb-4">Edit Vulnerability</h4>
                        
                        <div className="space-y-4">
                            <div>
                                <Label htmlFor="title">Vulnerability Title</Label>
                                <Input
                                    id="title"
                                    value={formData.title || ''}
                                    onChange={(e) => handleInputChange('title', e.target.value)}
                                    placeholder="Enter vulnerability title"
                                />
                            </div>

                            <div>
                                <Label htmlFor="description">Description</Label>
                                <Textarea
                                    id="description"
                                    value={formData.description || ''}
                                    onChange={(e) => handleInputChange('description', e.target.value)}
                                    placeholder="Enter vulnerability description"
                                    rows={4}
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <Label htmlFor="severity">Severity</Label>
                                    <EnhancedSelect
                                        value={formData.severity || ''}
                                        onValueChange={(value: string) => handleInputChange('severity', value)}
                                        colorType="severity"
                                    >
                                        <SelectTrigger>
                                            <SelectValue placeholder="Select severity" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="CRITICAL" color="#ef4444">Critical</SelectItem>
                                            <SelectItem value="HIGH" color="#f97316">High</SelectItem>
                                            <SelectItem value="MEDIUM" color="#eab308">Medium</SelectItem>
                                            <SelectItem value="LOW" color="#3b82f6">Low</SelectItem>
                                            <SelectItem value="INFO" color="#22c55e">Info</SelectItem>
                                            <SelectItem value="UNCLASSIFIED" color="#6b7280">Unclassified</SelectItem>
                                        </SelectContent>
                                    </EnhancedSelect>
                                </div>

                                <div>
                                    <Label htmlFor="status">Status</Label>
                                    <EnhancedSelect
                                        value={formData.status || ''}
                                        onValueChange={(value: string) => handleInputChange('status', value)}
                                        colorType="status"
                                    >
                                        <SelectTrigger>
                                            <SelectValue placeholder="Select status" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            <SelectItem value="OPEN" color="#ef4444">Open</SelectItem>
                                            <SelectItem value="IN_PROGRESS" color="#3b82f6">In Progress</SelectItem>
                                            <SelectItem value="RESOLVED" color="#22c55e">Resolved</SelectItem>
                                            <SelectItem value="ACCEPTED_RISK" color="#eab308">Accepted Risk</SelectItem>
                                            <SelectItem value="FALSE_POSITIVE" color="#6b7280">False Positive</SelectItem>
                                            <SelectItem value="RETEST_PENDING" color="#a855f7">Retest Pending</SelectItem>
                                            <SelectItem value="RETEST_FAILED" color="#ef4444">Retest Failed</SelectItem>
                                        </SelectContent>
                                    </EnhancedSelect>
                                </div>
                            </div>

                            <div>
                                <Label htmlFor="category">Category</Label>
                                <Select
                                    value={formData.category || ''}
                                    onValueChange={(value) => handleInputChange('category', value)}
                                >
                                    <SelectTrigger>
                                        <SelectValue placeholder="Select category" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="INJECTION">Injection</SelectItem>
                                        <SelectItem value="XSS">Cross-Site Scripting</SelectItem>
                                        <SelectItem value="AUTHENTICATION">Authentication</SelectItem>
                                        <SelectItem value="AUTHORIZATION">Authorization</SelectItem>
                                        <SelectItem value="CONFIGURATION">Configuration</SelectItem>
                                        <SelectItem value="CRYPTOGRAPHY">Cryptography</SelectItem>
                                        <SelectItem value="NETWORK">Network</SelectItem>
                                        <SelectItem value="OTHER">Other</SelectItem>
                                    </SelectContent>
                                </Select>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <Label htmlFor="cvss_score">CVSS Score</Label>
                                    <Input
                                        id="cvss_score"
                                        type="number"
                                        min="0"
                                        max="10"
                                        step="0.1"
                                        value={formData.cvss_score || ''}
                                        onChange={(e) => handleInputChange('cvss_score', parseFloat(e.target.value) || 0)}
                                        placeholder="0.0 - 10.0"
                                    />
                                </div>

                                <div>
                                    <Label htmlFor="cve_id">CVE ID</Label>
                                    <Input
                                        id="cve_id"
                                        value={formData.cve_id || ''}
                                        onChange={(e) => handleInputChange('cve_id', e.target.value)}
                                        placeholder="CVE-YYYY-NNNN"
                                    />
                                </div>
                            </div>

                            <div>
                                <Label htmlFor="affected_asset">Affected Asset</Label>
                                <Input
                                    id="affected_asset"
                                    value={formData.affected_asset || ''}
                                    onChange={(e) => handleInputChange('affected_asset', e.target.value)}
                                    placeholder="Enter affected asset"
                                />
                            </div>

                            <div>
                                <Label htmlFor="recommendation">Recommendation</Label>
                                <Textarea
                                    id="recommendation"
                                    value={formData.recommendation || ''}
                                    onChange={(e) => handleInputChange('recommendation', e.target.value)}
                                    placeholder="Enter remediation recommendation"
                                    rows={3}
                                />
                            </div>
                        </div>
                    </div>

                    {/* Footer Actions */}
                    <div className="flex justify-end gap-3 pt-4 border-t border-gray-200">
                        <Button variant="outline" onClick={onClose}>
                            Cancel
                        </Button>
                        <Button 
                            onClick={handleSave} 
                            disabled={isSaving}
                            className="bg-green-600 hover:bg-green-700"
                        >
                            {isSaving ? 'Saving...' : 'Save Changes'}
                        </Button>
                    </div>
                </div>
            </div>
        </FloatingWindow>
    );
}
