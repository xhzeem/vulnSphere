'use client';

import { useState, useEffect, useRef, useCallback } from 'react';
import { MDXEditorMethods } from '../md-editor-client';
import { useParams, useRouter } from 'next/navigation';
import api from '@/lib/api';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue, EnhancedSelect } from '@/components/ui/select';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { ArrowLeft, Save, Plus, X, Calculator, AlertCircle, Clock, CheckCircle, AlertTriangle, XCircle, RotateCcw } from 'lucide-react';
import { CVSSCalculator } from './cvss-calculator';
import { MDXEditorComponent } from '@/components/md-editor';
import { MultiSelect } from '@/components/ui/multi-select';
import { RetestCard } from './retest-card';
import { SeverityBadge } from './severity-badge';
import { StatusBadge } from './status-badge';
import { TemplateSelector } from '@/components/templates/template-selector';
import { AttachmentManager } from './attachment-manager';
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";

interface Asset {
    id: string;
    name: string;
    type: string;
    identifier: string;
}

interface VulnerabilityFormData {
    title: string;
    severity: string;
    status: string;
    cvss_base_score: string;
    cvss_vector: string;
    details_md: string;
    references: string[];
    asset_ids: string[];
}

interface VulnerabilityTemplate {
    title: string;
    severity: string;
    cvss_base_score?: number | string;
    cvss_vector?: string;
    details_md?: string;
    references?: string[];
}

export function VulnerabilityForm({ mode = 'create' }: { mode?: 'create' | 'edit' }) {
    const params = useParams();
    const router = useRouter();
    const projectId = params.projectId as string;
    const vulnId = mode === 'edit' ? (params.vulnId as string) : null;

    const [companyId, setCompanyId] = useState<string | null>(null);
    const [loading, setLoading] = useState(mode === 'edit');
    const [saving, setSaving] = useState(false);
    const [error, setError] = useState('');
    const [newReference, setNewReference] = useState('');
    const [cvssDialogOpen, setCvssDialogOpen] = useState(false);
    const [templateSelectorOpen, setTemplateSelectorOpen] = useState(false);
    const [pendingTemplate, setPendingTemplate] = useState<VulnerabilityTemplate | null>(null);
    const [confirmTemplateOpen, setConfirmTemplateOpen] = useState(false);
    const [assets, setAssets] = useState<Asset[]>([]);
    const mdxEditorRef = useRef<MDXEditorMethods>(null);
    const attachmentManagerRef = useRef<{ fetchAttachments: () => void } | null>(null);

    // Callback to refresh attachments when images are uploaded
    const handleImageUploaded = useCallback(() => {
        console.log('handleImageUploaded callback triggered');
        if (attachmentManagerRef.current) {
            console.log('Calling fetchAttachments on attachment manager');
            attachmentManagerRef.current.fetchAttachments();
        } else {
        console.log('attachmentManagerRef.current is null');
        }
    }, []);

    const [formData, setFormData] = useState<VulnerabilityFormData>({
        // ... (same initial state)
        title: '',
        severity: 'MEDIUM',
        status: 'OPEN',
        cvss_base_score: '',
        cvss_vector: '',
        details_md: `### Description

### Impact

### Likelihood

### Proof of Concept

### Steps to Reproduce
1. 
2. 

### Remediation
`,
        references: [],
        asset_ids: [],
    });

    useEffect(() => {
        const fetchData = async () => {
            try {
                // Fetch project to get company ID
                const projectRes = await api.get(`/projects/${projectId}/`);
                setCompanyId(projectRes.data.company);

                // Fetch project assets (scoped to this project only)
                const assetsRes = await api.get(`/companies/${projectRes.data.company}/projects/${projectId}/assets/`);
                setAssets(assetsRes.data.results || assetsRes.data || []);

                // If editing, fetch vulnerability data
                if (mode === 'edit' && vulnId) {
                    const vulnRes = await api.get(`/companies/${projectRes.data.company}/projects/${projectId}/vulnerabilities/${vulnId}/`);
                    setFormData({
                        title: vulnRes.data.title || '',
                        severity: vulnRes.data.severity || 'MEDIUM',
                        status: vulnRes.data.status || 'OPEN',
                        cvss_base_score: vulnRes.data.cvss_base_score?.toString() || '',
                        cvss_vector: vulnRes.data.cvss_vector || '',
                        details_md: vulnRes.data.details_md || '',
                        references: vulnRes.data.references || [],
                        asset_ids: vulnRes.data.assets?.map((a: Asset) => a.id) || [],
                    });
                }
            } catch (err) {
                console.error('Failed to load data', err);
                setError('Failed to load data');
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [projectId, vulnId, mode]);

    const handleUpload = async (file: File) => {
        if (!companyId) return '';
        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_name', file.name);

        try {
            const endpoint = vulnId
                ? `/companies/${companyId}/projects/${projectId}/vulnerabilities/${vulnId}/attachments/`
                : `/companies/${companyId}/projects/${projectId}/attachments/`;

            const response = await api.post(
                endpoint,
                formData,
                {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                    },
                }
            );
            return response.data.file;
        } catch (err) {
            console.error('Upload failed', err);
            return '';
        }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!companyId) return;

        setSaving(true);
        setError('');

        try {
            const payload = {
                title: formData.title,
                severity: formData.severity,
                status: formData.status,
                cvss_base_score: formData.cvss_base_score ? parseFloat(formData.cvss_base_score) : null,
                cvss_vector: formData.cvss_vector,
                details_md: formData.details_md,
                references: formData.references,
            };

            let vulnResponse;
            if (mode === 'create') {
                vulnResponse = await api.post(`/companies/${companyId}/projects/${projectId}/vulnerabilities/`, payload);
            } else {
                vulnResponse = await api.patch(`/companies/${companyId}/projects/${projectId}/vulnerabilities/${vulnId}/`, payload);
            }

            const createdVulnId = mode === 'create' ? vulnResponse.data.id : vulnId;

            // Handle Assets
            // Get current assets to diff
            const currentVuln = await api.get(`/companies/${companyId}/projects/${projectId}/vulnerabilities/${createdVulnId}/`);
            const currentAssetIds = currentVuln.data.assets?.map((a: Asset) => a.id) || [];

            // Add new assets
            for (const assetId of formData.asset_ids) {
                if (!currentAssetIds.includes(assetId)) {
                    try {
                        await api.post(`/companies/${companyId}/projects/${projectId}/vulnerabilities/${createdVulnId}/assets/`, {
                            asset: assetId
                        });
                    } catch (err) {
                        console.error(`Failed to add asset ${assetId}`, err);
                    }
                }
            }

            // Remove deselected assets
            for (const assetId of currentAssetIds) {
                if (!formData.asset_ids.includes(assetId)) {
                    try {
                        await api.delete(`/companies/${companyId}/projects/${projectId}/vulnerabilities/${createdVulnId}/assets/${assetId}/`);
                    } catch (err) {
                        console.error(`Failed to remove asset ${assetId}`, err);
                    }
                }
            }

            // router.push(`/project/${projectId}`);
            // Show success message instead of redirecting
            // We can use a simple alert for now or set a success state if we had a toast system
            // Since we don't have a toast system ready in this context (or haven't checked for one), 
            // I'll reuse the error state for general messages or just console log/alert for MVP as requested implicitly by "stop redirect"
            // Actually, let's just not redirect.
            setSaving(false);
            // Optionally refresh data if needed, but we updated inline mostly.
            // If create mode, we might want to redirect to edit mode or just stay? 
            // User said "not get redirected outside the vuln". 
            // If we are in create mode, we probably should redirect to the EDIT page of this new vuln so they can add retests/assets etc.
            // But if we are in EDIT mode, we stay.

            if (mode === 'create') {
                router.replace(`/project/${projectId}/vulnerabilities/${createdVulnId}/edit`);
            } else {
                // confirm save
                // alert('Saved successfully'); // annoying? 
            }
        } catch (err) {
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            const error = err as any;
            const errorMessage = error.response?.data?.detail ||
                error.response?.data?.title?.[0] ||
                `Failed to ${mode} vulnerability`;
            setError(errorMessage);
            setSaving(false);
        }
    };

    // ... (rest of methods unchanged)
    const handleAddReference = () => {
        if (!newReference.trim()) return;

        const lines = newReference.split('\n').map(line => line.trim()).filter(line => line);
        setFormData({ ...formData, references: [...formData.references, ...lines] });
        setNewReference('');
    };

    const handleRemoveReference = (index: number) => {
        const updatedRefs = formData.references.filter((_, i) => i !== index);
        setFormData({ ...formData, references: updatedRefs });
    };

    const handleCVSSCalculate = (score: number, vector: string, severity: string) => {
        setFormData({
            ...formData,
            cvss_base_score: score.toString(),
            cvss_vector: vector,
            severity: severity,
        });
    };

    const assetOptions = assets.map(a => ({
        label: `${a.name} (${a.type})`,
        value: a.id
    }));

    const handleTemplateSelect = (template: VulnerabilityTemplate) => {
        // Check if important fields already have data
        const hasData = formData.title || (formData.details_md && formData.details_md.length > 50);

        if (hasData) {
            setPendingTemplate(template);
            setConfirmTemplateOpen(true);
        } else {
            applyTemplate(template);
        }
    };

    const applyTemplate = (template: VulnerabilityTemplate) => {
        setFormData({
            ...formData,
            title: template.title,
            severity: template.severity,
            cvss_base_score: template.cvss_base_score?.toString() || '',
            cvss_vector: template.cvss_vector || '',
            details_md: template.details_md || '',
            references: template.references || [],
        });

        // Force update MDX editor content
        if (mdxEditorRef.current) {
            mdxEditorRef.current.setMarkdown(template.details_md || '');
        }

        setPendingTemplate(null);
        setConfirmTemplateOpen(false);
    };

    if (loading) {
        return (
            <div className="space-y-6">
                <Card>
                    <CardContent className="pt-6">
                        <p className="text-muted-foreground">Loading...</p>
                    </CardContent>
                </Card>
            </div>
        );
    }

    return (
        <>
            <form onSubmit={handleSubmit} className="space-y-6">
                {/* ... (header unchanged) */}
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <Button type="button" variant="ghost" size="icon" onClick={() => router.back()}>
                            <ArrowLeft className="h-4 w-4" />
                        </Button>
                        <div>
                            <h1 className="text-3xl font-bold tracking-tight">
                                {mode === 'create' ? 'Add' : 'Edit'} Vulnerability
                            </h1>
                            <p className="text-muted-foreground">
                                {mode === 'create' ? 'Create a new vulnerability finding' : 'Update vulnerability details'}
                            </p>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <Button type="button" variant="outline" onClick={() => setTemplateSelectorOpen(true)}>
                            Use Template
                        </Button>
                        <Button type="submit" disabled={saving}>
                            <Save className="mr-2 h-4 w-4" />
                            {saving ? 'Saving...' : mode === 'create' ? 'Create' : 'Save Changes'}
                        </Button>
                    </div>
                </div>

                {error && (
                    <Alert variant="destructive">
                        <AlertDescription>{error}</AlertDescription>
                    </Alert>
                )
                }

                <Card>
                    {/* ... (Basic Info Card content unchanged) */}
                    <CardHeader>
                        <CardTitle>Basic Information</CardTitle>
                        <CardDescription>Core details about the vulnerability</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="grid gap-2">
                            <Label htmlFor="title">Title *</Label>
                            <Input
                                id="title"
                                required
                                value={formData.title}
                                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                                placeholder="e.g., SQL Injection in Login Form"
                            />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="grid gap-2">
                                <Label htmlFor="severity">Severity *</Label>
                                <EnhancedSelect value={formData.severity} onValueChange={(value: string) => setFormData({ ...formData, severity: value })} colorType="severity">
                                    <SelectTrigger className="[&>span:first-child]:w-full">
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="CRITICAL" className="[&>span:not(.absolute)]:w-full" color="#ef4444">Critical</SelectItem>
                                        <SelectItem value="HIGH" className="[&>span:not(.absolute)]:w-full" color="#f97316">High</SelectItem>
                                        <SelectItem value="MEDIUM" className="[&>span:not(.absolute)]:w-full" color="#eab308">Medium</SelectItem>
                                        <SelectItem value="LOW" className="[&>span:not(.absolute)]:w-full" color="#3b82f6">Low</SelectItem>
                                        <SelectItem value="INFO" className="[&>span:not(.absolute)]:w-full" color="#22c55e">Info</SelectItem>
                                        <SelectItem value="UNCLASSIFIED" className="[&>span:not(.absolute)]:w-full" color="#6b7280">Unclassified</SelectItem>
                                    </SelectContent>
                                </EnhancedSelect>
                            </div>
                            <div className="grid gap-2">
                                <Label htmlFor="status">Status *</Label>
                                <EnhancedSelect value={formData.status} onValueChange={(value: string) => setFormData({ ...formData, status: value })} colorType="status">
                                    <SelectTrigger className="[&>span:first-child]:w-full">
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="OPEN" className="[&>span:not(.absolute)]:w-full" icon={<AlertCircle className="w-3 h-3" style={{ color: '#ef4444' }} />}>Open</SelectItem>
                                        <SelectItem value="IN_PROGRESS" className="[&>span:not(.absolute)]:w-full" icon={<Clock className="w-3 h-3" style={{ color: '#3b82f6' }} />}>In Progress</SelectItem>
                                        <SelectItem value="RESOLVED" className="[&>span:not(.absolute)]:w-full" icon={<CheckCircle className="w-3 h-3" style={{ color: '#22c55e' }} />}>Resolved</SelectItem>
                                        <SelectItem value="ACCEPTED_RISK" className="[&>span:not(.absolute)]:w-full" icon={<AlertTriangle className="w-3 h-3" style={{ color: '#eab308' }} />}>Accepted Risk</SelectItem>
                                        <SelectItem value="FALSE_POSITIVE" className="[&>span:not(.absolute)]:w-full" icon={<XCircle className="w-3 h-3" style={{ color: '#6b7280' }} />}>False Positive</SelectItem>
                                        <SelectItem value="RETEST_PENDING" className="[&>span:not(.absolute)]:w-full" icon={<RotateCcw className="w-3 h-3" style={{ color: '#a855f7' }} />}>Retest Pending</SelectItem>
                                        <SelectItem value="RETEST_FAILED" className="[&>span:not(.absolute)]:w-full" icon={<XCircle className="w-3 h-3" style={{ color: '#ef4444' }} />}>Retest Failed</SelectItem>
                                    </SelectContent>
                                </EnhancedSelect>
                            </div>
                            <div className="grid gap-2">
                                <Label htmlFor="cvss">CVSS Base Score</Label>
                                <div className="flex gap-2">
                                    <Input
                                        id="cvss"
                                        type="number"
                                        step="0.1"
                                        min="0"
                                        max="10"
                                        value={formData.cvss_base_score}
                                        onChange={(e) => setFormData({ ...formData, cvss_base_score: e.target.value })}
                                        placeholder="0.0 - 10.0"
                                    />
                                    <Button
                                        type="button"
                                        variant="outline"
                                        size="icon"
                                        onClick={() => setCvssDialogOpen(true)}
                                        title="CVSS Calculator"
                                    >
                                        <Calculator className="h-4 w-4" />
                                    </Button>
                                </div>
                            </div>
                            <div className="grid gap-2">
                                <Label htmlFor="cvss_vector">CVSS Vector</Label>
                                <Input
                                    id="cvss_vector"
                                    value={formData.cvss_vector}
                                    onChange={(e) => setFormData({ ...formData, cvss_vector: e.target.value })}
                                    placeholder="e.g., CVSS:3.1/AV:N..."
                                    readOnly
                                />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardHeader>
                        <CardTitle>Vulnerable Assets</CardTitle>
                        <CardDescription>Select project assets affected by this vulnerability</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <div className="grid gap-2">
                            <MultiSelect
                                options={assetOptions}
                                selected={formData.asset_ids}
                                onChange={(selected) => setFormData({ ...formData, asset_ids: selected })}
                                placeholder="Select affected assets..."
                                emptyMessage="No assets attached to this project."
                            />
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardHeader>
                        <CardTitle>Details</CardTitle>
                        <CardDescription>Use markdown formatting with sections as subtitles</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="grid gap-2">
                            <MDXEditorComponent
                                ref={mdxEditorRef}
                                value={formData.details_md}
                                onChange={(val) => setFormData({ ...formData, details_md: val })}
                                onUpload={handleUpload}
                                onImageUploaded={handleImageUploaded}
                                projectId={projectId}
                                companyId={companyId || undefined}
                                vulnerabilityId={vulnId || undefined}
                                context="vulnerability"
                                height={600}
                            />
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardHeader>
                        <CardTitle>References</CardTitle>
                        <CardDescription>Add reference URLs or citations (paste multiple lines to add several at once)</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="flex gap-2">
                            <Textarea
                                value={newReference}
                                onChange={(e) => setNewReference(e.target.value)}
                                placeholder="Enter reference URL or paste multiple lines..."
                                rows={3}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && e.ctrlKey) {
                                        e.preventDefault();
                                        handleAddReference();
                                    }
                                }}
                            />
                            <Button type="button" onClick={handleAddReference}>
                                <Plus className="h-4 w-4" />
                            </Button>
                        </div>
                        {formData.references.length > 0 && (
                            <div className="space-y-2">
                                {formData.references.map((ref, index) => (
                                    <div key={index} className="flex items-center gap-2 px-2 border rounded">
                                        <span className="flex-1 text-sm break-all">{ref}</span>
                                        <Button
                                            type="button"
                                            variant="ghost"
                                            size="sm"
                                            onClick={() => handleRemoveReference(index)}
                                        >
                                            <X className="h-4 w-4" />
                                        </Button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </CardContent>
                </Card>

                {companyId && (
                    <AttachmentManager
                        ref={attachmentManagerRef}
                        companyId={companyId}
                        projectId={projectId}
                        vulnerabilityId={vulnId || undefined}
                    />
                )}

                <CVSSCalculator
                    open={cvssDialogOpen}
                    onOpenChange={setCvssDialogOpen}
                    onCalculate={handleCVSSCalculate}
                    initialVector={formData.cvss_vector}
                />

                {
                    mode === 'edit' && companyId && vulnId && (
                        <RetestCard
                            companyId={companyId}
                            projectId={projectId}
                            vulnerabilityId={vulnId}
                            onImageUploaded={handleImageUploaded}
                        />
                    )
                }
            </form>

            <TemplateSelector
                open={templateSelectorOpen}
                onOpenChange={setTemplateSelectorOpen}
                onSelect={handleTemplateSelect}
            />

            <AlertDialog open={confirmTemplateOpen} onOpenChange={setConfirmTemplateOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>Overwrite existing data?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Applying this template will overwrite your current title, severity, details, and references. This action cannot be undone.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel onClick={() => setPendingTemplate(null)}>Cancel</AlertDialogCancel>
                        <AlertDialogAction onClick={() => pendingTemplate && applyTemplate(pendingTemplate)}>
                            Overwrite
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </>
    );
}
